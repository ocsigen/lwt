(* -*- tuareg -*- *)
(* The above line is how one tells Jbuilder that this file is in OCaml
   syntax. *)

let top = {|
(jbuild_version 1)

(library
 ((name lwt)
  (public_name lwt)
  (synopsis "Monadic promises and concurrent I/O")
  (wrapped false)
|}

let optional_bisect_stanza = {|
  (preprocess (pps (bisect_ppx)))
|}

let bottom = {|
  (libraries (bytes result))
  (flags (:standard -w +A-29))))
|}

let () =
  let generating_coverage =
    try Sys.getenv "BISECT_COVERAGE" = "yes"
    with Not_found -> false
  in

  let jbuild_file_contents =
    if generating_coverage then
      top ^ optional_bisect_stanza ^ bottom
    else
      top ^ bottom
  in

  Jbuild_plugin.V1.send jbuild_file_contents
