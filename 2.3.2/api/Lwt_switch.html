<html><head><title>Module Lwt_switch </title><meta charset="utf8"/><link rel="stylesheet" href="https://ocsigen.org/lwt/tmp/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="text/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Lwt</p><div class="mainmenu"><p><span class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></span>
<span class="mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></span>
</p><p><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p class="mainmenu-current"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="https://ocsigen.org/lwt/tmp/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h1>Lwt - API Reference</h1><h2>Core library</h2><h3><a href=".././api/Lwt" class="ocsimore_phrasing_link">Lwt</a></h3><h3><a href=".././api/Lwt_condition" class="ocsimore_phrasing_link">Lwt_condition</a></h3><h3><a href=".././api/Lwt_list" class="ocsimore_phrasing_link">Lwt_list</a></h3><h3><a href=".././api/Lwt_mutex" class="ocsimore_phrasing_link">Lwt_mutex</a></h3><h3><a href=".././api/Lwt_mvar" class="ocsimore_phrasing_link">Lwt_mvar</a></h3><h3><a href=".././api/Lwt_pool" class="ocsimore_phrasing_link">Lwt_pool</a></h3><h3><a href=".././api/Lwt_sequence" class="ocsimore_phrasing_link">Lwt_sequence</a></h3><h3><a href=".././api/Lwt_pqueue" class="ocsimore_phrasing_link">Lwt_pqueue</a></h3><h3><a href=".././api/Lwt_stream" class="ocsimore_phrasing_link">Lwt_stream</a></h3><h3><a href=".././api/Lwt_switch" class="ocsimore_phrasing_link">Lwt_switch</a></h3><h2>Unix bindings</h2><h3><a href=".././api/Lwt_daemon" class="ocsimore_phrasing_link">Lwt_daemon</a></h3><h3><a href=".././api/Lwt_gc" class="ocsimore_phrasing_link">Lwt_gc</a></h3><h3><a href=".././api/Lwt_io" class="ocsimore_phrasing_link">Lwt_io</a></h3><h3><a href=".././api/Lwt_log" class="ocsimore_phrasing_link">Lwt_log</a></h3><h3><a href=".././api/Lwt_main" class="ocsimore_phrasing_link">Lwt_main</a></h3><h3><a href=".././api/Lwt_engine" class="ocsimore_phrasing_link">Lwt_engine</a></h3><h3><a href=".././api/Lwt_process" class="ocsimore_phrasing_link">Lwt_process</a></h3><h3><a href=".././api/Lwt_throttle" class="ocsimore_phrasing_link">Lwt_throttle</a></h3><h3><a href=".././api/Lwt_timeout" class="ocsimore_phrasing_link">Lwt_timeout</a></h3><h3><a href=".././api/Lwt_unix" class="ocsimore_phrasing_link">Lwt_unix</a></h3><h3><a href=".././api/Lwt_bytes" class="ocsimore_phrasing_link">Lwt_bytes</a></h3><h3><a href=".././api/Lwt_sys" class="ocsimore_phrasing_link">Lwt_sys</a></h3><h2>Reactive programming helpers</h2><h3><a href=".././api/Lwt_react" class="ocsimore_phrasing_link">Lwt_react</a></h3><h2>Syntax extensions</h2><h3><a href=".././api/Pa_lwt" class="ocsimore_phrasing_link">Pa_lwt</a></h3><h3><a href=".././api/Pa_lwt_log" class="ocsimore_phrasing_link">Pa_lwt_log</a></h3><h2>Terminal manipulation</h2><h3><a href=".././api/Lwt_read_line" class="ocsimore_phrasing_link">Lwt_read_line</a></h3><h3><a href=".././api/Lwt_term" class="ocsimore_phrasing_link">Lwt_term</a></h3><h3><a href=".././api/Lwt_text" class="ocsimore_phrasing_link">Lwt_text</a></h3><h2>Miscellaneous</h2><h3><a href=".././api/Lwt_glib" class="ocsimore_phrasing_link">Lwt_glib</a></h3><h3><a href=".././api/Lwt_lib" class="ocsimore_phrasing_link">Lwt_lib</a></h3><h3><a href=".././api/Lwt_preemptive" class="ocsimore_phrasing_link">Lwt_preemptive</a></h3><h3><a href=".././api/Lwt_ssl" class="ocsimore_phrasing_link">Lwt_ssl</a></h3><h2>Index</h2><h3> <span><a href=".././api/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/index_attributes">Index of class attributes</a></span></h3><h3> <span><a href=".././api/index_methods">Index of class methods</a></span></h3><h3> <span><a href=".././api/index_classes">Index of classes</a></span></h3><h3> <span><a href=".././api/index_class_types">Index of class types</a></span></h3><h3> <span><a href=".././api/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/index_module_types">Index of module types</a></span></h3></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../1.0.0/api/Lwt_switch">1.0.0</option><option value=".././../1.1.0/api/Lwt_switch">1.1.0</option><option value=".././../2.0.0/api/Lwt_switch">2.0.0</option><option value=".././../2.1.0/api/Lwt_switch">2.1.0</option><option value=".././../2.1.1/api/Lwt_switch">2.1.1</option><option value=".././../2.2.0/api/Lwt_switch">2.2.0</option><option value=".././../2.2.1/api/Lwt_switch">2.2.1</option><option value=".././../2.3.0/api/Lwt_switch">2.3.0</option><option value=".././../2.3.1/api/Lwt_switch">2.3.1</option><option value=".././../2.3.2/api/Lwt_switch" selected="selected">2.3.2</option><option value=".././../2.4.0/api/Lwt_switch">2.4.0</option><option value=".././../2.4.1/api/Lwt_switch">2.4.1</option><option value=".././../2.4.2/api/Lwt_switch">2.4.2</option><option value=".././../2.4.3/api/Lwt_switch">2.4.3</option><option value=".././../2.4.7/api/Lwt_switch">2.4.7</option><option value=".././../2.4.8/api/Lwt_switch">2.4.8</option><option value=".././../2.5.0/api/Lwt_switch">2.5.0</option><option value=".././../2.5.1/api/Lwt_switch">2.5.1</option><option value=".././../2.5.2/api/Lwt_switch">2.5.2</option><option value=".././../2.6.0/api/Lwt_switch">2.6.0</option><option value=".././../2.7.0/api/Lwt_switch">2.7.0</option><option value=".././../2.7.1/api/Lwt_switch">2.7.1</option><option value=".././../3.0.0/api/Lwt_switch">3.0.0</option><option value=".././../3.1.0/api/Lwt_switch">3.1.0</option><option value=".././../3.2.1/api/Lwt_switch">3.2.1</option><option value=".././../3.3.0/api/Lwt_switch">3.3.0</option><option value=".././../4.0.0/api/Lwt_switch">4.0.0</option><option value=".././../4.0.1/api/Lwt_switch">4.0.1</option><option value=".././../4.1.0/api/Lwt_switch">4.1.0</option><option value=".././../dev/api/Lwt_switch">dev</option></select><nav class="how-doctree"><h1>Lwt - API Reference</h1><h2>Core library</h2><h3><a href=".././api/Lwt" class="ocsimore_phrasing_link">Lwt</a></h3><h3><a href=".././api/Lwt_condition" class="ocsimore_phrasing_link">Lwt_condition</a></h3><h3><a href=".././api/Lwt_list" class="ocsimore_phrasing_link">Lwt_list</a></h3><h3><a href=".././api/Lwt_mutex" class="ocsimore_phrasing_link">Lwt_mutex</a></h3><h3><a href=".././api/Lwt_mvar" class="ocsimore_phrasing_link">Lwt_mvar</a></h3><h3><a href=".././api/Lwt_pool" class="ocsimore_phrasing_link">Lwt_pool</a></h3><h3><a href=".././api/Lwt_sequence" class="ocsimore_phrasing_link">Lwt_sequence</a></h3><h3><a href=".././api/Lwt_pqueue" class="ocsimore_phrasing_link">Lwt_pqueue</a></h3><h3><a href=".././api/Lwt_stream" class="ocsimore_phrasing_link">Lwt_stream</a></h3><h3><a href=".././api/Lwt_switch" class="ocsimore_phrasing_link">Lwt_switch</a></h3><h2>Unix bindings</h2><h3><a href=".././api/Lwt_daemon" class="ocsimore_phrasing_link">Lwt_daemon</a></h3><h3><a href=".././api/Lwt_gc" class="ocsimore_phrasing_link">Lwt_gc</a></h3><h3><a href=".././api/Lwt_io" class="ocsimore_phrasing_link">Lwt_io</a></h3><h3><a href=".././api/Lwt_log" class="ocsimore_phrasing_link">Lwt_log</a></h3><h3><a href=".././api/Lwt_main" class="ocsimore_phrasing_link">Lwt_main</a></h3><h3><a href=".././api/Lwt_engine" class="ocsimore_phrasing_link">Lwt_engine</a></h3><h3><a href=".././api/Lwt_process" class="ocsimore_phrasing_link">Lwt_process</a></h3><h3><a href=".././api/Lwt_throttle" class="ocsimore_phrasing_link">Lwt_throttle</a></h3><h3><a href=".././api/Lwt_timeout" class="ocsimore_phrasing_link">Lwt_timeout</a></h3><h3><a href=".././api/Lwt_unix" class="ocsimore_phrasing_link">Lwt_unix</a></h3><h3><a href=".././api/Lwt_bytes" class="ocsimore_phrasing_link">Lwt_bytes</a></h3><h3><a href=".././api/Lwt_sys" class="ocsimore_phrasing_link">Lwt_sys</a></h3><h2>Reactive programming helpers</h2><h3><a href=".././api/Lwt_react" class="ocsimore_phrasing_link">Lwt_react</a></h3><h2>Syntax extensions</h2><h3><a href=".././api/Pa_lwt" class="ocsimore_phrasing_link">Pa_lwt</a></h3><h3><a href=".././api/Pa_lwt_log" class="ocsimore_phrasing_link">Pa_lwt_log</a></h3><h2>Terminal manipulation</h2><h3><a href=".././api/Lwt_read_line" class="ocsimore_phrasing_link">Lwt_read_line</a></h3><h3><a href=".././api/Lwt_term" class="ocsimore_phrasing_link">Lwt_term</a></h3><h3><a href=".././api/Lwt_text" class="ocsimore_phrasing_link">Lwt_text</a></h3><h2>Miscellaneous</h2><h3><a href=".././api/Lwt_glib" class="ocsimore_phrasing_link">Lwt_glib</a></h3><h3><a href=".././api/Lwt_lib" class="ocsimore_phrasing_link">Lwt_lib</a></h3><h3><a href=".././api/Lwt_preemptive" class="ocsimore_phrasing_link">Lwt_preemptive</a></h3><h3><a href=".././api/Lwt_ssl" class="ocsimore_phrasing_link">Lwt_ssl</a></h3><h2>Index</h2><h3> <span><a href=".././api/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/index_attributes">Index of class attributes</a></span></h3><h3> <span><a href=".././api/index_methods">Index of class methods</a></span></h3><h3> <span><a href=".././api/index_classes">Index of classes</a></span></h3><h3> <span><a href=".././api/index_class_types">Index of class types</a></span></h3><h3> <span><a href=".././api/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/index_module_types">Index of module types</a></span></h3></nav></nav><article class="rightcol"><h1>Module <span><a href=".././api/Lwt_switch">Lwt_switch</a></span> </h1><pre class="ocsforge_color odocwiki_code"><span class="ocsforge_color_keyword">module</span> <span class="ocsforge_color_uid"><span class="ocsforge_color_uid">Lwt_switch</span></span> <span class="ocsforge_color_delimiter">:</span> <span class="ocsforge_color_keyword">sig</span><span><a href=".././api/Lwt_switch">..</a></span><span class="ocsforge_color_keyword">end</span></pre><p>Lwt switches<br/>
</p><hr/><p><br/>
Switch have two goals:<br/>
</p><ul><li> being able to free multiple resources at the same time,
</li><li> offer a better alternative than always returning an id to free
some resource.
</li></ul><p>For example, considers the following interface:<br/>
</p><p>
</p><pre class=""><code class="language-ocaml translatable">type id

      val free : id -&gt; unit Lwt.t

      val f : unit -&gt; id Lwt.t
      val g : unit -&gt; id Lwt.t
      val h : unit -&gt; id Lwt.t</code></pre><p><br/>
</p><p>Now you want to calls <span class="odocwiki_inlinecode">f</span>, <span class="odocwiki_inlinecode">g</span> and <span class="odocwiki_inlinecode">h</span> in parallel. You can
simply do:<br/>
</p><p>
</p><pre class=""><code class="language-ocaml translatable">lwt idf = f () and idg = g () and idh = h () in
      ...</code></pre><p><br/>
</p><p>However, one may wants to handle possible failures of <span class="odocwiki_inlinecode">f ()</span>, <span class="odocwiki_inlinecode">g
()</span> and <span class="odocwiki_inlinecode">h ()</span>, and disable all allocated resources if one of
these three threads fails. This may be hard since you have to
remember which one failed and which one returned correctly.<br/>
</p><p>Now we change a little bit the interface:<br/>
</p><p>
</p><pre class=""><code class="language-ocaml translatable">val f : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
      val g : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t
      val h : ?switch : Lwt_switch.t -&gt; unit -&gt; id Lwt.t</code></pre><p><br/>
</p><p>and the code becomes:<br/>
</p><p>
</p><pre class=""><code class="language-ocaml translatable">let switch = Lwt_switch.create () in
      try_lwt
        lwt idf = f ~switch () and idg = g ~switch () and idh = h ~switch () in
        ...
      with exn -&gt;
        lwt () = Lwt_switch.turn_off switch in
        raise_lwt exn</code></pre><p><br/>
</p><pre class="ocsforge_color odocwiki_code" id="TYPEt"><span class="ocsforge_color_keyword">type</span> <span class="odocwiki_name">t</span></pre><div class="odocwiki_info"><p>Type of switches.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALcreate"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">create</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type">unit <span class="ocsforge_color_delimiter">-&gt;</span> <span><a href=".././api/Lwt_switch#TYPEt">t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">create ()</span> creates a new switch.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALis_on"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">is_on</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> <span class="ocsforge_color_delimiter">-&gt;</span> bool</span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">is_on switch</span> returns <span class="odocwiki_inlinecode">true</span> if the switch is currently on, and
<span class="odocwiki_inlinecode">false</span> otherwise.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALturn_off"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">turn_off</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">turn_off switch</span> turns off the switch. It calls all registered
hooks, waits for all of them to terminates, and the returns. If
one of the hook failed, then it will fail with one of the
exception raised by hooks. If the switch is already off, then it
does nothing.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="EXCEPTIONOff"><span class="ocsforge_color_keyword">exception</span> <span class="odocwiki_name">Off</span></pre><div class="odocwiki_info"><p>Exception raised when trying to add a hook to a switch that is
already off.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALcheck"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">check</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option <span class="ocsforge_color_delimiter">-&gt;</span> unit</span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">check switch</span> does nothing if <span class="odocwiki_inlinecode">switch</span> is <span class="odocwiki_inlinecode">None</span> or contains an
switch that is currently on, and raise <span><a href=".././api/Lwt_switch#EXCEPTIONOff">Lwt_switch.Off</a></span> otherwise.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALadd_hook"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">add_hook</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option <span class="ocsforge_color_delimiter">-&gt;</span> <span class="ocsforge_color_delimiter">(</span>unit <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span><span class="ocsforge_color_delimiter">)</span> <span class="ocsforge_color_delimiter">-&gt;</span> unit</span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">add_hook switch f</span> registers <span class="odocwiki_inlinecode">f</span> so it will be called when
<span><a href=".././api/Lwt_switch#VALturn_off">Lwt_switch.turn_off</a></span> is invoked. It does nothing if <span class="odocwiki_inlinecode">switch</span> is
<span class="odocwiki_inlinecode">None</span>. If <span class="odocwiki_inlinecode">switch</span> contains an switch that is already off then
<span><a href=".././api/Lwt_switch#EXCEPTIONOff">Lwt_switch.Off</a></span> is raised.<br/></p></div><pre class="ocsforge_color odocwiki_code" id="VALadd_hook_or_exec"><span class="ocsforge_color_keyword">val</span> <span class="odocwiki_name">add_hook_or_exec</span> <span class="ocsforge_color_delimiter">:</span> <span class="odocwiki_type"><span><a href=".././api/Lwt_switch#TYPEt">t</a></span> option <span class="ocsforge_color_delimiter">-&gt;</span> <span class="ocsforge_color_delimiter">(</span>unit <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span><span class="ocsforge_color_delimiter">)</span> <span class="ocsforge_color_delimiter">-&gt;</span> unit <span><a href=".././api/Lwt#TYPEt">Lwt.t</a></span></span></pre><div class="odocwiki_info"><p><span class="odocwiki_inlinecode">add_hook_or_exec switch f</span> is the same as <span><a href=".././api/Lwt_switch#VALadd_hook">Lwt_switch.add_hook</a></span> except
that if the switch is already off, then <span class="odocwiki_inlinecode">f</span> is called
immediatly.<br/></p></div></article></div></div></body></html>
